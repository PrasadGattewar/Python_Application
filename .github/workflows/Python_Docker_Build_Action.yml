name: Build and Push to ACR

on:
  # Use this property for manual trigger
  workflow_dispatch:
  
  # pull_request:
  #   branches:
  #     - main

# permissions:
#   id-token: write
#   contents: read

jobs:
  build-and-Push:
    runs-on: ubuntu-latest

    steps:
    # Checkout Repository
    - uses: actions/checkout@v4.2.2

    # Azure Login
    - name: Azure Login
      uses: azure/login@v2.3.0
      with:
        # auth-type: IDENTITY
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        # enable-AzPSSession: true

    # Azure CLI
    - name: Azure CLI script
      uses: azure/cli@v2.1.0
      with:
        azcliversion: latest
        inlineScript: |
          az account show

    # Docker Login for ACR by fetching the creds
    - name: Docker Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_NAME }}.azurecr.io
        username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

    # # Docker login to ACR 
    # - name: Docker login to ACR
    #   run: |
    #     az acr login --name ${{ secrets.ACR_NAME }}

    - name: Move requirements.txt to root (for Docker build)
      run: cp msdocs-python-flask-webapp-quickstart-main/requirements.txt .

    - name: Build and Push to ACR
      uses: docker/build-push-action@v2
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ secrets.ACR_NAME }}.azurecr.io/my-python-app:latest
        no-cache: true

